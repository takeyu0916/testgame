<!DOCTYPE html>
<html>
<head>
    <title>ã‚†ã†ãã‚“ã®çˆ†èµ°ã‚µã‚¦ãƒ³ãƒ‰STG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #0b0d2b; font-family: sans-serif; }
        canvas { display: block; }
    </style>
</head>
<body>
    <script type="module">
        import kaplay from "https://unpkg.com/kaplay@3001.0.0-alpha.20/dist/kaplay.mjs";

        const k = kaplay({
            width: 320,
            height: 480,
            letterbox: true,
            background: [11, 13, 43],
        });

        // 1. ç”»åƒã¨ã‚µã‚¦ãƒ³ãƒ‰ã®ãƒ­ãƒ¼ãƒ‰
        k.loadSprite("p1", "player1.png").catch(() => {});
        k.loadSprite("p2", "player2.png").catch(() => {});
        
        // Kaplayå…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«éŸ³æºã‚’æ‹å€Ÿã™ã‚‹ã§ï¼
        k.loadSound("shoot_snd", "https://kaplayjs.com/examples/sounds/Laser_002.wav");
        k.loadSound("expl_snd", "https://kaplayjs.com/examples/sounds/Explosion_001.wav");
        k.loadSound("bgm", "https://kaplayjs.com/examples/sounds/Other_World.mp3");

        function addParticles(p, char) {
            for (let i = 0; i < 8; i++) {
                k.add([
                    k.text(char, { size: 16 }),
                    k.pos(p),
                    k.move(k.rand(0, 360), k.rand(60, 180)),
                    k.opacity(1),
                    k.lifespan(0.4, { fade: 0.5 }),
                ]);
            }
        }

        // --- ã‚·ãƒ¼ãƒ³ï¼šã‚­ãƒ£ãƒ©é¸æŠ ---
        k.scene("select", () => {
            k.add([k.text("SELECT CHAR", { size: 24 }), k.pos(k.center().x, 80), k.anchor("center")]);

            const opts = [
                { id: "p1", type: "sprite", label: "ã‚†ã†ã„ã¡ãã‚“", x: k.center().x - 90 },
                { id: "p2", type: "sprite", label: "ã¾ã¿ã¡ã‚ƒã‚“", x: k.center().x },
                { id: "ğŸ˜º", type: "text", label: "ã­ã“ã¡ã‚ƒã‚“", x: k.center().x + 90 }
            ];

            opts.forEach(opt => {
                const obj = k.add([
                    opt.type === "sprite" ? k.sprite(opt.id) : k.text(opt.id, { size: 40 }),
                    k.pos(opt.x, 240),
                    k.anchor("center"),
                    k.area(),
                    opt.type === "sprite" ? k.scale(0.15) : null,
                    "choice"
                ]);
                k.onClick("choice", (c) => {
                    if (c === obj) k.go("main", opt);
                });
            });
        });

        // --- ã‚·ãƒ¼ãƒ³ï¼šãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ  ---
        k.scene("main", (charData) => {
            let score = 0;
            let hp = 3;

            // BGMã‚’ãƒ«ãƒ¼ãƒ—å†ç”Ÿï¼
            const music = k.play("bgm", { loop: true, volume: 0.4 });

            const scoreLabel = k.add([k.text(`Score: ${score}`, { size: 20 }), k.pos(20, 20)]);
            const hpLabel = k.add([k.text(`HP: ${"â¤ï¸".repeat(hp)}`, { size: 20 }), k.pos(20, 50)]);

            const player = k.add([
                charData.type === "sprite" ? k.sprite(charData.id) : k.text(charData.id, { size: 40 }),
                k.pos(k.center().x, 420),
                k.anchor("center"),
                k.area(),
                charData.type === "sprite" ? k.scale(0.15) : null,
                "player"
            ]);

            k.onUpdate(() => {
                if (k.isMouseDown()) {
                    const mpos = k.mousePos();
                    if (mpos.x < player.pos.x - 10) player.move(-280, 0);
                    if (mpos.x > player.pos.x + 10) player.move(280, 0);
                }
            });

            k.onMousePress(() => {
                k.play("shoot_snd", { volume: 0.3 }); // æ’ƒã¤éŸ³ï¼
                k.add([
                    k.text("âœ¨", { size: 24 }),
                    k.pos(player.pos.x, player.pos.y - 30),
                    k.anchor("center"),
                    k.area(),
                    k.move(k.UP, 600),
                    k.offscreen({ destroy: true }),
                    "bullet"
                ]);
            });

            k.loop(1.0, () => {
                const e = k.add([
                    k.text(k.choose(["â­", "ğŸŒŸ", "ğŸ‘¾", "ğŸ›¸"]), { size: 30 }),
                    k.pos(k.rand(40, 280), -20),
                    k.anchor("center"),
                    k.area(),
                    k.move(k.DOWN, k.rand(120, 200)),
                    "enemy"
                ]);
                e.onUpdate(() => {
                    if (e.pos.y > 480) {
                        k.destroy(e);
                        hp--;
                        hpLabel.text = `HP: ${"â¤ï¸".repeat(hp)}`;
                        if (hp <= 0) {
                            music.stop(); // è² ã‘ãŸã‚‰BGMæ­¢ã‚ã‚‹
                            k.go("lose", score);
                        }
                    }
                });
            });

            k.onCollide("bullet", "enemy", (b, e) => {
                const pos = e.pos;
                k.destroy(b);
                k.destroy(e);
                k.play("expl_snd", { volume: 0.4 }); // çˆ†ç™ºéŸ³ï¼
                score += 10;
                scoreLabel.text = `Score: ${score}`;
                addParticles(pos, "ğŸ’©"); 
            });
        });

        k.scene("lose", (score) => {
            k.add([k.text("GAME OVER", { size: 32 }), k.pos(k.center()), k.anchor("center")]);
            k.onMousePress(() => k.go("select"));
        });

        k.go("select");

    </script>
</body>
</html>
