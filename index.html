<!DOCTYPE html>
<html>
<head>
    <title>ã‚†ã†ãã‚“ã®çˆ†èµ°ã‚µã‚¦ãƒ³ãƒ‰STG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #0b0d2b; font-family: sans-serif; }
        canvas { display: block; }
    </style>
</head>
<body>
    <script type="module">
        import kaplay from "https://unpkg.com/kaplay@3001.0.0-alpha.20/dist/kaplay.mjs";

        const k = kaplay({
            width: 320,
            height: 480,
            letterbox: true,
            background: [11, 13, 43],
        });

        // 1. ç”»åƒã®ãƒ­ãƒ¼ãƒ‰ï¼ˆéŸ³å£°ãƒ­ãƒ¼ãƒ‰ã¯å‰Šé™¤ã—ãŸã§ï¼‰
        for (let i = 1; i <= 5; i++) {
            k.loadSprite(`p${i}`, `player${i}.png`).catch(() => {
                console.log(`player${i}.png ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
            });
        }

        // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ã®é–¢æ•°
        function addParticles(p, char) {
            for (let i = 0; i < 8; i++) {
                k.add([
                    k.text(char, { size: 16 }),
                    k.pos(p),
                    k.move(k.rand(0, 360), k.rand(60, 180)),
                    k.opacity(1),
                    k.lifespan(0.4, { fade: 0.5 }),
                ]);
            }
        }

        // --- ã‚·ãƒ¼ãƒ³ï¼šã‚­ãƒ£ãƒ©é¸æŠ ---
        k.scene("select", () => {
            k.add([k.text("SELECT CHAR", { size: 24 }), k.pos(k.center().x, 60), k.anchor("center")]);

            // 5ã¤ã®ç”»åƒã‚­ãƒ£ãƒ© + ğŸ±ã‚’è¿½åŠ 
            const opts = [
                { id: "p1", type: "sprite", label: "No.1", x: 60, y: 180 },
                { id: "p2", type: "sprite", label: "No.2", x: 160, y: 180 },
                { id: "p3", type: "sprite", label: "No.3", x: 260, y: 180 },
                { id: "p4", type: "sprite", label: "No.4", x: 60, y: 300 },
                { id: "p5", type: "sprite", label: "No.5", x: 160, y: 300 },
                { id: "ğŸ±", type: "text",   label: "NEKO", x: 260, y: 300 }
            ];

            opts.forEach(opt => {
                const obj = k.add([
                    opt.type === "sprite" ? k.sprite(opt.id) : k.text(opt.id, { size: 40 }),
                    k.pos(opt.x, opt.y),
                    k.anchor("center"),
                    k.area(),
                    opt.type === "sprite" ? k.scale(0.15) : null,
                    "choice"
                ]);

                k.add([
                    k.text(opt.label, { size: 12 }),
                    k.pos(opt.x, opt.y + 40),
                    k.anchor("center")
                ]);

                k.onClick("choice", (c) => {
                    if (c === obj) k.go("main", opt);
                });
            });
        });

        // --- ã‚·ãƒ¼ãƒ³ï¼šãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ  ---
        k.scene("main", (charData) => {
            let score = 0;
            let hp = 3;

            const scoreLabel = k.add([k.text(`Score: ${score}`, { size: 20 }), k.pos(20, 20)]);
            const hpLabel = k.add([k.text(`HP: ${"â¤ï¸".repeat(hp)}`, { size: 20 }), k.pos(20, 50)]);

            const player = k.add([
                charData.type === "sprite" ? k.sprite(charData.id) : k.text(charData.id, { size: 40 }),
                k.pos(k.center().x, 420),
                k.anchor("center"),
                k.area(),
                charData.type === "sprite" ? k.scale(0.15) : null,
                "player"
            ]);

            k.onUpdate(() => {
                if (k.isMouseDown()) {
                    const mpos = k.mousePos();
                    if (mpos.x < player.pos.x - 10) player.move(-280, 0);
                    if (mpos.x > player.pos.x + 10) player.move(280, 0);
                }
            });

            k.onMousePress(() => {
                k.add([
                    k.text("âœ¨", { size: 24 }),
                    k.pos(player.pos.x, player.pos.y - 30),
                    k.anchor("center"),
                    k.area(),
                    k.move(k.UP, 600),
                    k.offscreen({ destroy: true }),
                    "bullet"
                ]);
            });

            k.loop(1.0, () => {
                const e = k.add([
                    k.text(k.choose(["â­", "ğŸŒŸ", "ğŸ‘¾", "ğŸ›¸"]), { size: 30 }),
                    k.pos(k.rand(40, 280), -20),
                    k.anchor("center"),
                    k.area(),
                    k.move(k.DOWN, k.rand(120, 200)),
                    "enemy"
                ]);
                e.onUpdate(() => {
                    if (e.pos.y > 480) {
                        k.destroy(e);
                        hp--;
                        hpLabel.text = `HP: ${"â¤ï¸".repeat(hp)}`;
                        if (hp <= 0) k.go("lose", score);
                    }
                });
            });

            k.onCollide("bullet", "enemy", (b, e) => {
                const pos = e.pos;
                k.destroy(b);
                k.destroy(e);
                score += 10;
                scoreLabel.text = `Score: ${score}`;
                
                // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®å‡ºã—åˆ†ã‘
                if (charData.id === "ğŸ±") {
                    addParticles(pos, "ğŸŸ"); // ã­ã“ã¡ã‚ƒã‚“ã¯é­šï¼
                } else if (charData.id === "p2" || charData.id === "p5") {
                    addParticles(pos, "ğŸŒ¸"); // 2ã¨5ã¯æ¡œ
                } else {
                    addParticles(pos, "ğŸ’©"); // ãã®ä»–ã¯ğŸ’©
                }
            });
        });

        k.scene("lose", (score) => {
            k.add([k.text("GAME OVER", { size: 32 }), k.pos(k.center()), k.anchor("center")]);
            k.add([k.text(`Score: ${score}`, { size: 24 }), k.pos(k.center().x, k.center().y + 50), k.anchor("center")]);
            k.onMousePress(() => k.go("select"));
        });

        k.go("select");

    </script>
</body>
</html>
