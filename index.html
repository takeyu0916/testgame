<!DOCTYPE html>
<html>
<head>
    <title>ãŸã‘ãã‚“ã®çˆ†èµ°ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«STG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #0b0d2b; font-family: sans-serif; }
        canvas { display: block; }
    </style>
</head>
<body>
    <script type="module">
        import kaplay from "https://unpkg.com/kaplay@3001.0.0-alpha.20/dist/kaplay.mjs";

        const k = kaplay({
            width: 320,
            height: 480,
            letterbox: true,
            background: [11, 13, 43],
        });

        // ç”»åƒã®ãƒ­ãƒ¼ãƒ‰ï¼ˆç”»åƒãŒãªã„å ´åˆã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã—ã¦ã‚‹ã§ï¼‰
        k.loadSprite("p1", "player1.png").catch(() => console.log("p1 not found"));
        k.loadSprite("p2", "player2.png").catch(() => console.log("p2 not found"));

        // --- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼ˆã¦ã‚“ã¦ã‚“ï¼‰ã‚’ä½œã‚‹é–¢æ•° ---
        function addParticles(p, char) {
            for (let i = 0; i < 8; i++) { // 8å€‹ãã‚‰ã„é£›ã°ã™ã¨è³‘ã‚„ã‹ï¼
                k.add([
                    k.text(char, { size: 16 }),
                    k.pos(p),
                    // å…¨æ–¹å‘ã«ãƒ©ãƒ³ãƒ€ãƒ ã«é£›ã°ã™
                    k.move(k.rand(0, 360), k.rand(60, 180)),
                    k.opacity(1),
                    // 0.4ç§’ã§æ¶ˆãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
                    k.lifespan(0.4, { fade: 0.5 }),
                ]);
            }
        }

        // --- ã‚·ãƒ¼ãƒ³ï¼šã‚­ãƒ£ãƒ©é¸æŠ ---
        k.scene("select", () => {
            k.add([k.text("SELECT CHAR", { size: 24 }), k.pos(k.center().x, 80), k.anchor("center")]);

            const opts = [
                { id: "p1", type: "sprite", label: "Mushroom", x: k.center().x - 90 },
                { id: "p2", type: "sprite", label: "Hero", x: k.center().x },
                { id: "ğŸ°", type: "text", label: "Bunny", x: k.center().x + 90 }
            ];

            opts.forEach(opt => {
                const obj = k.add([
                    opt.type === "sprite" ? k.sprite(opt.id) : k.text(opt.id, { size: 40 }),
                    k.pos(opt.x, 240),
                    k.anchor("center"),
                    k.area(),
                    opt.type === "sprite" ? k.scale(0.15) : null,
                    "choice"
                ]);
                k.add([k.text(opt.label, { size: 10 }), k.pos(opt.x, 300), k.anchor("center")]);

                obj.onClick(() => k.go("main", opt));
            });
        });

        // --- ã‚·ãƒ¼ãƒ³ï¼šãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ  ---
        k.scene("main", (charData) => {
            let score = 0;
            let hp = 3;

            const scoreLabel = k.add([k.text(`Score: ${score}`, { size: 20 }), k.pos(20, 20)]);
            const hpLabel = k.add([k.text(`HP: ${"â¤ï¸".repeat(hp)}`, { size: 20 }), k.pos(20, 50)]);

            const player = k.add([
                charData.type === "sprite" ? k.sprite(charData.id) : k.text(charData.id, { size: 40 }),
                k.pos(k.center().x, 420),
                k.anchor("center"),
                k.area(),
                charData.type === "sprite" ? k.scale(0.15) : null,
                "player"
            ]);

            // æ“ä½œ
            k.onUpdate(() => {
                if (k.isMouseDown()) {
                    const mpos = k.mousePos();
                    if (mpos.x < player.pos.x - 10) player.move(-280, 0);
                    if (mpos.x > player.pos.x + 10) player.move(280, 0);
                }
            });

            // å¼¾
            k.onMousePress(() => {
                k.add([
                    k.text("âœ¨", { size: 24 }),
                    k.pos(player.pos.x, player.pos.y - 30),
                    k.anchor("center"),
                    k.area(),
                    k.move(k.UP, 600),
                    k.offscreen({ destroy: true }),
                    "bullet"
                ]);
            });

            // æ•µ
            k.loop(1.0, () => {
                const e = k.add([
                    k.text(k.choose(["â­", "ğŸŒŸ", "ğŸ‘¾", "ğŸ›¸"]), { size: 30 }),
                    k.pos(k.rand(40, 280), -20),
                    k.anchor("center"),
                    k.area(),
                    k.move(k.DOWN, k.rand(120, 200)),
                    "enemy"
                ]);

                e.onUpdate(() => {
                    if (e.pos.y > 480) {
                        k.destroy(e);
                        hp--;
                        hpLabel.text = `HP: ${"â¤ï¸".repeat(hp)}`;
                        k.shake(5);
                        if (hp <= 0) k.go("lose", score);
                    }
                });
            });

            // å½“ãŸã‚Šåˆ¤å®šï¼šã“ã“ã§ã€Œã¦ã‚“ã¦ã‚“ã€ã‚’å‘¼ã³å‡ºã™ï¼
            k.onCollide("bullet", "enemy", (b, e) => {
                const pos = e.pos;
                k.destroy(b);
                k.destroy(e);
                score += 10;
                scoreLabel.text = `Score: ${score}`;
                
                // ãŸã‘ãã‚“ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ¼”å‡ºï¼
                addParticles(pos, "ğŸ’©"); 
            });
        });

        // --- ã‚·ãƒ¼ãƒ³ï¼šã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ ---
        k.scene("lose", (score) => {
            k.add([k.text("GAME OVER", { size: 32 }), k.pos(k.center()), k.anchor("center")]);
            k.add([k.text(`Score: ${score}`, { size: 24 }), k.pos(k.center().x, k.center().y + 60), k.anchor("center")]);
            k.add([k.text("Tap to Restart", { size: 16 }), k.pos(k.center().x, k.center().y + 120), k.anchor("center")]);
            k.onMousePress(() => k.go("select"));
        });

        k.go("select");

    </script>
</body>
</html>
